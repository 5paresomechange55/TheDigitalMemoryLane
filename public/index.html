<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Digital Memory Lane</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body {
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      font-family: 'Courier New', Courier, monospace;
    }

    canvas {
      background-color: #fff8dc;
      border: 2px dashed #888;
      touch-action: none;
    }

    .btn {
      @apply px-4 py-2 rounded shadow text-white bg-blue-700 hover:bg-blue-900;
    }

    .btn-red {
      @apply bg-red-600 hover:bg-red-800;
    }

    .btn-yellow {
      @apply bg-yellow-600 hover:bg-yellow-700 text-black;
    }
  </style>
</head>
<body class="flex flex-col items-center p-6 space-y-6">
  <header class="text-center">
    <h1 class="text-4xl font-bold text-blue-900 drop-shadow">ðŸ§  The Digital Memory Lane ðŸ“¸</h1>
    <p class="mt-2 text-lg text-gray-700 max-w-xl mx-auto">
      Immortalize your pixel in internet history â€“ $1 per pixel. Select your spot, make a mark forever.
    </p>
  </header>

  <div class="flex flex-col items-center space-y-2">
    <canvas id="pixelCanvas" width="1000" height="3000" class="w-full max-w-full touch-none"></canvas>

    <div class="flex space-x-3 mt-2">
      <button id="undoBtn" class="btn btn-yellow">Undo</button>
      <button id="deselectAllBtn" class="btn btn-red">Deselect All</button>
      <button id="checkoutBtn" class="btn">Checkout</button>
    </div>

    <p id="totalPrice" class="mt-2 text-lg font-semibold text-gray-800">Total: $0</p>
  </div>

  <footer class="mt-10 text-sm text-gray-500">
    &copy; 2025 TheDigitalMemoryLane.com. Your memory lives here.
  </footer>

  <script>
    const canvas = document.getElementById("pixelCanvas");
    const ctx = canvas.getContext("2d");
    const selectedPixels = new Set();
    const pixelSize = 1;
    const undoStack = [];

    let scale = 1;
    let originX = 0;
    let originY = 0;
    let isDragging = false;
    let dragStart = { x: 0, y: 0 };

    canvas.addEventListener("mousedown", (e) => {
      isDragging = true;
      dragStart.x = e.offsetX;
      dragStart.y = e.offsetY;
    });

    canvas.addEventListener("mousemove", (e) => {
      if (!isDragging) return;
      const dx = e.offsetX - dragStart.x;
      const dy = e.offsetY - dragStart.y;
      originX += dx;
      originY += dy;
      dragStart = { x: e.offsetX, y: e.offsetY };
      drawCanvas();
    });

    canvas.addEventListener("mouseup", () => {
      isDragging = false;
    });

    canvas.addEventListener("wheel", (e) => {
      e.preventDefault();
      const zoom = e.deltaY < 0 ? 1.1 : 0.9;
      scale *= zoom;
      drawCanvas();
    });

    canvas.addEventListener("click", (e) => {
      if (isDragging) return;

      const x = Math.floor((e.offsetX - originX) / scale);
      const y = Math.floor((e.offsetY - originY) / scale);
      const key = `${x},${y}`;

      if (selectedPixels.has(key)) {
        selectedPixels.delete(key);
      } else {
        selectedPixels.add(key);
        undoStack.push(key);
      }

      drawCanvas();
      updateTotal();
    });

    document.getElementById("undoBtn").addEventListener("click", () => {
      const last = undoStack.pop();
      if (last) selectedPixels.delete(last);
      drawCanvas();
      updateTotal();
    });

    document.getElementById("deselectAllBtn").addEventListener("click", () => {
      selectedPixels.clear();
      undoStack.length = 0;
      drawCanvas();
      updateTotal();
    });

    document.getElementById("checkoutBtn").addEventListener("click", async () => {
      const pixels = selectedPixels.size;
      if (pixels === 0) {
        alert("Please select at least one pixel.");
        return;
      }

      const res = await fetch("/create-checkout-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ pixels }),
      });

      const { id } = await res.json();
      const stripe = Stripe("pk_test_51RTDqT2c0Glb9QyZNKJzKHIZMfZXmAHBPzFVyxhz22a2cPmsOmzEswfHCYsd68z8HXbeASNV8fI0zoRr3SCSIjTC005jaokCP9");
      stripe.redirectToCheckout({ sessionId: id });
    });

    function updateTotal() {
      document.getElementById("totalPrice").textContent = `Total: $${selectedPixels.size}`;
    }

    function drawCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.translate(originX, originY);
      ctx.scale(scale, scale);

      for (let pixel of selectedPixels) {
        const [x, y] = pixel.split(",").map(Number);
        ctx.fillStyle = "#ff69b4"; // nostalgic hot pink
        ctx.fillRect(x, y, pixelSize, pixelSize);
      }

      ctx.restore();
    }

    drawCanvas();
  </script>
</body>
</html>
